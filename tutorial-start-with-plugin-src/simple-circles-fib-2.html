<!DOCTYPE html>
<meta charset="utf-8">

<svg width="960" height="500"></svg>

<script src="d3.min.js"></script>
<!-- <script src="d3-foo.js"></script> -->
<script src="d3-fib.js"></script>

<script>

// ToDo: figure out why loading extra d3-nnn.js files slows down page load so much!!! gotta be a rollup thing

var svg = d3.select("svg");

var width = svg.attr("width")-100;
var height = svg.attr("height");
var r = 10;

var n = 20; //d3.foo();
var fib = d3.fib();
fib.pop();  // we don't want all of the data, at this time

console.log(fib)


// ToDo: might want to put this in the fib plugin?
var bins = [];
for (var i in fib){
  bins[i] = {max: fib[i], count: 0, i:+i} // Adding an index here, to make drawing boxes easier later
}


var open_bin = 0;
function getBin(bins){
  var b = open_bin
  for(b in bins){
    // ToDo: make sure we return 'out of bounds' if we run out of bin space
    if(bins[b].count < bins[b].max){
      bins[b].count++;
      open_bin = b;
      return b;
    }
  }
}


function maxHeight(bin, dy){
  return  bin.max * 3.5*dy;
}

function getY(i, bin, height, dy){
  var max = height - 2*dy;
  var min = height - 2*dy - i*dy;
  return (Math.random() * (max - min) + min);
}


// create dataset of points
var circles = d3.range(n).map(function(i) {
  
  var bin = getBin(bins);
  
  return {
    x: (width/bins.length) * bin, 
    y: getY(i, bin, height, 10),
    bin: bin,
    id: i 
  };
});


// Draw the circle graph elements
svg.selectAll("circle")
  .data(circles)
  .enter().append("circle")
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; })
    .attr("r", r)
    .style("fill", "#6A8891")
    .style("stroke", "#FFF");
    

// Draw the bar graph elements
svg.selectAll("rect")
  .data(bins)
  .enter().append("rect")
    .attr("width", 28)
    .attr("height", function(d){ return maxHeight(d, r) })
    .attr("x", function(d){ return (width/bins.length * d.i) -14; })
    .attr("y", function(d){ return height - maxHeight(d, r) })
    .style("stroke", "#ccc")
    .style("fill-opacity", .2)
    .style("fill", "#ccc")

</script>

